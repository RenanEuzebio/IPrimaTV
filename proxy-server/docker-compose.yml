version: '3.8'

services:
  # Main proxy server
  proxy:
    build: .
    container_name: iprimatv-proxy
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - HOST=0.0.0.0
      - TRUST_PROXY=true
      - CORS_ORIGIN=${CORS_ORIGIN:-*}
      - API_KEY=${API_KEY:-}
      - RATE_LIMIT_WINDOW=${RATE_LIMIT_WINDOW:-60000}
      - RATE_LIMIT_MAX=${RATE_LIMIT_MAX:-100}
      - MAX_CONCURRENT_STREAMS=${MAX_CONCURRENT_STREAMS:-10}
      - PROXY_ROTATION_ENABLED=${PROXY_ROTATION_ENABLED:-false}
      - PROXY_LIST=${PROXY_LIST:-}
      - ROTATION_STRATEGY=${ROTATION_STRATEGY:-round-robin}
      - STRIP_HEADERS=${STRIP_HEADERS:-true}
      - ROTATE_USER_AGENT=${ROTATE_USER_AGENT:-true}
      - LOGGING_ENABLED=${LOGGING_ENABLED:-true}
      - LOG_LEVEL=${LOG_LEVEL:-combined}
    networks:
      - proxy-network
    depends_on:
      - tor
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  # Tor service for enhanced anonymity (optional)
  tor:
    image: dperson/torproxy:latest
    container_name: iprimatv-tor
    restart: unless-stopped
    ports:
      - "9050:9050"  # SOCKS5 proxy
      - "9051:9051"  # Control port
    networks:
      - proxy-network
    environment:
      - TOR_NewCircuitPeriod=60
      - TOR_MaxCircuitDirtiness=600
    healthcheck:
      test: ["CMD", "curl", "--fail", "--socks5-hostname", "localhost:9050", "https://check.torproject.org/api/ip"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  proxy-network:
    driver: bridge

# To use Tor, set in your .env:
# PROXY_ROTATION_ENABLED=true
# PROXY_LIST=socks5://tor:9050

# To run without Tor:
# docker-compose up -d proxy
#
# To run with Tor:
# docker-compose up -d
