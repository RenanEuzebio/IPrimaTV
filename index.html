<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Xtream HLS Channel Player</title>

  <!-- hls.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <style>
    :root {
      --bg-dark: #111;
      --bg-light: #1e1e1e;
      --accent: #007aff;
      --text: #fff;
      --text-muted: #bbb;
    }
    html,body{
      height:100%;
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      overflow:hidden;
      display:flex;
    }
    /* Sidebar */
    #sidebar{
      width:260px;
      background:var(--bg-light);
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      border-right:2px solid #000;
    }
    #channels{
      list-style:none;
      margin:0;
      padding:0;
    }
    .ch-item{
      padding:0.65rem 0.9rem;
      cursor:pointer;
      user-select:none;
      border-bottom:1px solid #222;
      transition:background .2s;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .ch-item:hover{background:#2d2d2d;}
    .ch-item.active{background:var(--accent);}

    /* Video area */
    #player-wrapper{
      flex:1 1 auto;
      display:flex;
      flex-direction:column;
    }
    video{
      width:100%;
      height:100%;
      background:#000;
    }
    #error{
      padding:0.5rem;
      font-size:0.9rem;
      color:#f66;
      display:none;
      background:#222;
    }
  </style>
</head>
<body>
  <!-- Sidebar with channels -->
  <aside id="sidebar">
    <ul id="channels"><li style="padding:1rem;color:var(--text-muted)">Loading…</li></ul>
  </aside>

  <!-- Player -->
  <div id="player-wrapper">
    <div id="error"></div>
    <video id="video" controls autoplay muted></video>
  </div>

  <script>
  (async function(){
    const listEl = document.getElementById('channels');
    const video  = document.getElementById('video');
    const errBox = document.getElementById('error');
    let hls;

    function showError(msg){
      errBox.textContent=msg;
      errBox.style.display='block';
      console.error(msg);
    }
    function clearError(){errBox.style.display='none';}

    // Fetch channels.json (structure: [{id,name,url}, …])
    let channels=[];
    try{
      const resp = await fetch('./channels.json');
      if(!resp.ok) throw new Error(resp.status+" "+resp.statusText);
      channels = await resp.json();
    }catch(e){
      listEl.innerHTML='<li style="padding:1rem;color:#f66">Failed to load channels.json</li>';
      showError('Could not fetch channels.json — '+e.message);
      return;
    }
    if(!Array.isArray(channels)||!channels.length){
      listEl.innerHTML='<li style="padding:1rem;color:#f66">channels.json is empty</li>';
      return;
    }

    // Build sidebar list
    listEl.innerHTML='';
    channels.forEach((ch,idx)=>{
      const li=document.createElement('li');
      li.className='ch-item';
      li.textContent=ch.name||('Channel '+ch.id);
      li.dataset.url=ch.url;
      li.dataset.idx=idx;
      li.addEventListener('click',()=>select(li));
      listEl.appendChild(li);
    });

    function destroyHls(){if(hls){hls.destroy();hls=null;}}

    function play(url){
      destroyHls();
      clearError();
      if(url.endsWith('.m3u8')&&Hls.isSupported()){
        hls=new Hls({maxBufferSize:30*1000*1000});
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.ERROR,(evt,data)=>{
          showError('HLS error: '+data.type);
        });
      }else if(video.canPlayType('application/vnd.apple.mpegurl')){
        video.src=url;
      }else{
        video.src=url;
      }
      video.play().catch(()=>{/* autoplay blocked */});
    }

    function select(item){
      document.querySelectorAll('.ch-item').forEach(el=>el.classList.toggle('active',el===item));
      const url=item.dataset.url;
      play(url);
    }

    // Auto‑select first channel
    select(listEl.firstChild);
  })();
  </script>
</body>
</html>
