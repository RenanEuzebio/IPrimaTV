<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>M3U Live Player</title>

    <!-- Google Fonts - Roboto (M3 typography) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Material Symbols (M3 icons) -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

    <!-- Tailwind CSS Play CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // M3 Primary tonal palette
                        primary: {
                            DEFAULT: '#D0BCFF',
                            container: '#4F378B',
                            on: '#381E72',
                            'on-container': '#EADDFF',
                        },
                        secondary: {
                            DEFAULT: '#CCC2DC',
                            container: '#4A4458',
                            on: '#332D41',
                            'on-container': '#E8DEF8',
                        },
                        tertiary: {
                            DEFAULT: '#EFB8C8',
                            container: '#633B48',
                            on: '#492532',
                            'on-container': '#FFD8E4',
                        },
                        // M3 Surface colors (dark theme)
                        surface: {
                            DEFAULT: '#141218',
                            dim: '#141218',
                            bright: '#3B383E',
                            container: {
                                lowest: '#0F0D13',
                                low: '#1D1B20',
                                DEFAULT: '#211F26',
                                high: '#2B2930',
                                highest: '#36343B',
                            },
                        },
                        'on-surface': '#E6E0E9',
                        'on-surface-variant': '#CAC4D0',
                        outline: '#938F99',
                        'outline-variant': '#49454F',
                        // M3 Error
                        error: {
                            DEFAULT: '#F2B8B5',
                            container: '#8C1D18',
                            on: '#601410',
                            'on-container': '#F9DEDC',
                        },
                        // Inverse
                        'inverse-surface': '#E6E0E9',
                        'inverse-on-surface': '#322F35',
                        'inverse-primary': '#6750A4',
                    },
                    fontFamily: {
                        sans: ['Roboto', 'sans-serif'],
                    },
                    borderRadius: {
                        'xs': '4px',
                        'sm': '8px',
                        'md': '12px',
                        'lg': '16px',
                        'xl': '28px',
                        'full': '9999px',
                    },
                    boxShadow: {
                        'elevation-1': '0 1px 2px rgba(0,0,0,0.3), 0 1px 3px 1px rgba(0,0,0,0.15)',
                        'elevation-2': '0 1px 2px rgba(0,0,0,0.3), 0 2px 6px 2px rgba(0,0,0,0.15)',
                        'elevation-3': '0 4px 8px 3px rgba(0,0,0,0.15), 0 1px 3px rgba(0,0,0,0.3)',
                    },
                    transitionTimingFunction: {
                        'm3-standard': 'cubic-bezier(0.2, 0, 0, 1)',
                        'm3-emphasized': 'cubic-bezier(0.2, 0, 0, 1)',
                    },
                },
            },
        }
    </script>

    <!-- External player libraries -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/mpegts.js@latest"></script>

    <style>
        /* M3 scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #49454F;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #938F99;
        }

        /* Custom styles for Alpine transitions */
        [x-cloak] { display: none !important; }

        /* M3 state layer */
        .state-layer {
            position: relative;
            overflow: hidden;
        }
        .state-layer::before {
            content: '';
            position: absolute;
            inset: 0;
            background: currentColor;
            opacity: 0;
            transition: opacity 200ms cubic-bezier(0.2, 0, 0, 1);
            pointer-events: none;
        }
        .state-layer:hover::before {
            opacity: 0.08;
        }
        .state-layer:focus::before,
        .state-layer:active::before {
            opacity: 0.12;
        }

        /* Material Symbols config */
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
    </style>
</head>
<body class="bg-surface text-on-surface font-sans h-screen overflow-hidden" x-cloak x-data="appData()">
    <div class="flex h-full">
        <!-- Navigation Drawer / Sidebar -->
        <aside
            x-show="sidebarOpen"
            x-transition:enter="transition ease-m3-standard duration-300"
            x-transition:enter-start="-translate-x-full"
            x-transition:enter-end="translate-x-0"
            x-transition:leave="transition ease-m3-standard duration-200"
            x-transition:leave-start="translate-x-0"
            x-transition:leave-end="-translate-x-full"
            class="w-80 lg:w-96 h-full bg-surface-container-low flex flex-col border-r border-outline-variant shrink-0"
        >
            <!-- Drawer Header -->
            <div class="p-4 border-b border-outline-variant">
                <h1 class="text-xl font-medium text-on-surface mb-4">Channels</h1>

                <!-- M3 Search Field (Outlined) -->
                <div class="relative">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-on-surface-variant">search</span>
                    <input
                        type="text"
                        x-model="searchQuery"
                        @input="filterChannels()"
                        placeholder="Search channels..."
                        class="w-full h-14 pl-12 pr-10 bg-transparent border border-outline rounded-xs text-on-surface placeholder:text-on-surface-variant focus:outline-none focus:border-primary focus:border-2 transition-colors"
                    />
                    <button
                        x-show="searchQuery.length > 0"
                        @click="searchQuery = ''; filterChannels()"
                        class="absolute right-3 top-1/2 -translate-y-1/2 text-on-surface-variant hover:text-on-surface state-layer rounded-full p-1"
                    >
                        <span class="material-symbols-outlined text-xl">close</span>
                    </button>
                </div>

                <!-- M3 Exposed Dropdown Menu (Group Filter) -->
                <div class="mt-4 relative" x-data="{ dropdownOpen: false }">
                    <button
                        @click="dropdownOpen = !dropdownOpen"
                        @click.outside="dropdownOpen = false"
                        class="w-full h-14 px-4 bg-transparent border border-outline rounded-xs text-on-surface flex items-center justify-between hover:bg-surface-container state-layer transition-colors"
                    >
                        <span class="flex items-center gap-3">
                            <span class="material-symbols-outlined text-on-surface-variant">filter_list</span>
                            <span class="truncate" x-text="selectedGroup === 'all' ? 'All channels' : selectedGroup"></span>
                        </span>
                        <span class="material-symbols-outlined transition-transform" :class="dropdownOpen ? 'rotate-180' : ''">expand_more</span>
                    </button>

                    <!-- Dropdown Menu -->
                    <div
                        x-show="dropdownOpen"
                        x-transition:enter="transition ease-m3-standard duration-200"
                        x-transition:enter-start="opacity-0 scale-95"
                        x-transition:enter-end="opacity-100 scale-100"
                        x-transition:leave="transition ease-m3-standard duration-150"
                        x-transition:leave-start="opacity-100 scale-100"
                        x-transition:leave-end="opacity-0 scale-95"
                        class="absolute z-50 mt-1 w-full max-h-80 overflow-y-auto bg-surface-container-high rounded-xs shadow-elevation-2 border border-outline-variant"
                    >
                        <button
                            @click="selectGroup('all'); dropdownOpen = false"
                            class="w-full px-4 py-3 text-left text-on-surface hover:bg-surface-container-highest state-layer flex items-center gap-3"
                            :class="selectedGroup === 'all' ? 'bg-secondary-container text-on-secondary-container' : ''"
                        >
                            <span class="material-symbols-outlined text-xl" x-show="selectedGroup === 'all'">check</span>
                            <span class="ml-8" x-show="selectedGroup !== 'all'"></span>
                            <span>All channels</span>
                            <span class="ml-auto text-sm text-on-surface-variant" x-text="channels.length"></span>
                        </button>
                        <template x-for="group in channelGroups" :key="group">
                            <button
                                @click="selectGroup(group); dropdownOpen = false"
                                class="w-full px-4 py-3 text-left text-on-surface hover:bg-surface-container-highest state-layer flex items-center gap-3"
                                :class="selectedGroup === group ? 'bg-secondary-container text-on-secondary-container' : ''"
                            >
                                <span class="material-symbols-outlined text-xl" x-show="selectedGroup === group">check</span>
                                <span class="w-6" x-show="selectedGroup !== group"></span>
                                <span class="truncate" x-text="group"></span>
                                <span class="ml-auto text-sm text-on-surface-variant" x-text="channels.filter(c => c.group === group).length"></span>
                            </button>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Channel List -->
            <div class="flex-1 overflow-y-auto">
                <!-- Loading State -->
                <div x-show="isLoading" class="flex items-center justify-center h-32">
                    <div class="animate-spin">
                        <span class="material-symbols-outlined text-4xl text-primary">progress_activity</span>
                    </div>
                </div>

                <!-- Error State -->
                <div x-show="hasError" class="p-4 m-4 bg-error-container rounded-md">
                    <p class="text-error-on-container text-sm">Error loading playlist file.</p>
                </div>

                <!-- Channel Items -->
                <div x-show="!isLoading && !hasError" class="py-2">
                    <template x-for="channel in filteredChannels" :key="channel.url">
                        <button
                            @click="playChannel(channel)"
                            class="w-full px-4 py-3 flex items-center gap-4 text-left state-layer transition-colors"
                            :class="currentChannel?.url === channel.url ? 'bg-secondary-container' : 'hover:bg-surface-container'"
                        >
                            <!-- Channel Logo -->
                            <div class="w-10 h-10 rounded-full bg-surface-container-highest flex items-center justify-center overflow-hidden shrink-0">
                                <img
                                    :src="channel.logo"
                                    :alt="channel.name"
                                    class="w-full h-full object-cover"
                                    @error="$event.target.style.display='none'; $event.target.nextElementSibling.style.display='flex'"
                                />
                                <span class="material-symbols-outlined text-on-surface-variant hidden items-center justify-center">tv</span>
                            </div>
                            <!-- Channel Info -->
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-on-surface truncate" x-text="channel.name"></p>
                                <p class="text-xs text-on-surface-variant truncate" x-text="channel.group"></p>
                            </div>
                            <!-- Playing Indicator -->
                            <span
                                x-show="currentChannel?.url === channel.url"
                                class="material-symbols-outlined text-primary"
                            >play_circle</span>
                        </button>
                    </template>

                    <!-- Empty State -->
                    <div x-show="filteredChannels.length === 0 && !isLoading" class="p-8 text-center">
                        <span class="material-symbols-outlined text-5xl text-on-surface-variant mb-2">search_off</span>
                        <p class="text-on-surface-variant">No channels found</p>
                    </div>
                </div>
            </div>

            <!-- Channel Count -->
            <div class="p-4 border-t border-outline-variant">
                <p class="text-xs text-on-surface-variant text-center">
                    <span x-text="filteredChannels.length"></span> of <span x-text="channels.length"></span> channels
                </p>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col bg-surface-dim relative">
            <!-- Top Bar -->
            <div class="absolute top-4 left-4 right-4 z-10 flex items-center justify-between">
                <!-- Toggle Sidebar Button -->
                <button
                    @click="sidebarOpen = !sidebarOpen"
                    class="h-10 px-4 bg-surface-container-high/90 backdrop-blur rounded-full text-on-surface flex items-center gap-2 shadow-elevation-1 state-layer hover:bg-surface-container-highest/90 transition-colors"
                >
                    <span class="material-symbols-outlined" x-text="sidebarOpen ? 'menu_open' : 'menu'"></span>
                    <span class="text-sm font-medium" x-text="sidebarOpen ? 'Hide' : 'Show'"></span>
                </button>

                <!-- Convert Playlist Button -->
                <button
                    @click="converterModalOpen = true"
                    class="h-10 px-4 bg-surface-container-high/90 backdrop-blur rounded-full text-on-surface flex items-center gap-2 shadow-elevation-1 state-layer hover:bg-surface-container-highest/90 transition-colors"
                >
                    <span class="material-symbols-outlined">swap_horiz</span>
                    <span class="text-sm font-medium hidden sm:inline">Convert Playlist</span>
                </button>
            </div>

            <!-- Video Player Container -->
            <div class="flex-1 flex items-center justify-center p-4 pt-20">
                <div class="w-full max-w-5xl aspect-video bg-black rounded-lg overflow-hidden shadow-elevation-3">
                    <video
                        id="video"
                        controls
                        preload="none"
                        class="w-full h-full"
                    ></video>
                </div>
            </div>

            <!-- Now Playing Info -->
            <div x-show="currentChannel" class="absolute bottom-20 left-1/2 -translate-x-1/2">
                <div class="bg-surface-container-high/90 backdrop-blur px-4 py-2 rounded-full shadow-elevation-1 flex items-center gap-3">
                    <span class="material-symbols-outlined text-primary animate-pulse">fiber_manual_record</span>
                    <span class="text-sm text-on-surface" x-text="currentChannel?.name"></span>
                </div>
            </div>
        </main>
    </div>

    <!-- Snackbar for Stream Status -->
    <div
        id="snackbar"
        x-show="streamStatus"
        x-transition:enter="transition ease-m3-standard duration-300"
        x-transition:enter-start="translate-y-full opacity-0"
        x-transition:enter-end="translate-y-0 opacity-100"
        x-transition:leave="transition ease-m3-standard duration-200"
        x-transition:leave-start="translate-y-0 opacity-100"
        x-transition:leave-end="translate-y-full opacity-0"
        class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50"
    >
        <div
            class="px-4 py-3 rounded-xs shadow-elevation-2 flex items-center gap-3 min-w-[288px] max-w-[560px]"
            :class="streamStatus?.includes('error') || streamStatus?.includes('Error') || streamStatus?.includes('Unable')
                ? 'bg-error-container text-error-on-container'
                : 'bg-inverse-surface text-inverse-on-surface'"
        >
            <span class="material-symbols-outlined text-xl" x-text="streamStatus?.includes('error') || streamStatus?.includes('Error') || streamStatus?.includes('Unable') ? 'error' : 'info'"></span>
            <span class="text-sm flex-1" x-text="streamStatus"></span>
            <button @click="streamStatus = ''" class="state-layer rounded-full p-1 -mr-1">
                <span class="material-symbols-outlined text-xl">close</span>
            </button>
        </div>
    </div>

    <!-- Converter Modal (M3 Full-screen Dialog) -->
    <div
        id="converter-modal"
        x-show="converterModalOpen"
        x-transition:enter="transition ease-m3-standard duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-m3-standard duration-200"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60"
        @click.self="converterModalOpen = false"
    >
        <div
            x-show="converterModalOpen"
            x-transition:enter="transition ease-m3-standard duration-300"
            x-transition:enter-start="opacity-0 scale-95 translate-y-4"
            x-transition:enter-end="opacity-100 scale-100 translate-y-0"
            x-transition:leave="transition ease-m3-standard duration-200"
            x-transition:leave-start="opacity-100 scale-100 translate-y-0"
            x-transition:leave-end="opacity-0 scale-95 translate-y-4"
            class="w-full max-w-3xl max-h-[90vh] bg-surface-container-high rounded-xl shadow-elevation-3 flex flex-col overflow-hidden"
        >
            <!-- Modal Header -->
            <div class="flex items-center gap-4 px-6 py-4 border-b border-outline-variant">
                <button
                    @click="converterModalOpen = false"
                    class="state-layer rounded-full p-2 -ml-2 text-on-surface"
                >
                    <span class="material-symbols-outlined">close</span>
                </button>
                <h2 class="text-xl font-medium text-on-surface flex-1">M3U8 to JavaScript Converter</h2>
            </div>

            <!-- Modal Body -->
            <div class="flex-1 overflow-y-auto p-6 space-y-6">
                <!-- Step 1: Input -->
                <div class="space-y-3">
                    <h3 class="text-base font-medium text-on-surface flex items-center gap-2">
                        <span class="w-6 h-6 rounded-full bg-primary text-primary-on text-sm flex items-center justify-center">1</span>
                        Input M3U8 Content
                    </h3>

                    <!-- File Upload -->
                    <label class="block">
                        <div class="h-14 px-4 border-2 border-dashed border-outline rounded-md flex items-center justify-center gap-3 cursor-pointer hover:border-primary hover:bg-surface-container transition-colors">
                            <span class="material-symbols-outlined text-on-surface-variant">upload_file</span>
                            <span class="text-on-surface-variant">Select M3U8 file or drop here</span>
                        </div>
                        <input
                            type="file"
                            accept=".m3u,.m3u8"
                            @change="handleFileSelect($event)"
                            class="hidden"
                        />
                    </label>

                    <div class="flex items-center gap-3">
                        <div class="flex-1 h-px bg-outline-variant"></div>
                        <span class="text-xs text-on-surface-variant">or paste content</span>
                        <div class="flex-1 h-px bg-outline-variant"></div>
                    </div>

                    <!-- Text Input -->
                    <textarea
                        x-model="converterInput"
                        @input="convertPlaylist()"
                        placeholder="Paste M3U8 content here..."
                        rows="8"
                        spellcheck="false"
                        class="w-full p-4 bg-surface-container border border-outline rounded-md text-on-surface placeholder:text-on-surface-variant focus:outline-none focus:border-primary focus:border-2 resize-none font-mono text-sm"
                    ></textarea>

                    <p class="text-xs text-on-surface-variant">
                        Characters: <span class="font-medium" x-text="converterInput.length.toLocaleString()"></span>
                    </p>
                </div>

                <!-- Step 2: Output -->
                <div class="space-y-3">
                    <h3 class="text-base font-medium text-on-surface flex items-center gap-2">
                        <span class="w-6 h-6 rounded-full bg-primary text-primary-on text-sm flex items-center justify-center">2</span>
                        Generated JavaScript Module
                    </h3>

                    <div class="bg-surface-container-lowest border border-outline-variant rounded-md overflow-hidden">
                        <pre class="p-4 overflow-x-auto text-sm font-mono text-on-surface max-h-64 overflow-y-auto"><code x-text="converterOutput || '// Paste M3U8 content above or select a file'"></code></pre>
                    </div>

                    <div class="flex items-center justify-between">
                        <p class="text-xs text-on-surface-variant">
                            Channels: <span class="font-medium" x-text="converterChannelCount"></span>
                        </p>
                    </div>
                </div>

                <!-- Help Section -->
                <div class="bg-surface-container p-4 rounded-md space-y-2">
                    <h4 class="text-sm font-medium text-on-surface flex items-center gap-2">
                        <span class="material-symbols-outlined text-lg">help</span>
                        How to use
                    </h4>
                    <ol class="text-sm text-on-surface-variant list-decimal list-inside space-y-1">
                        <li>Select an M3U8 file or paste the content directly</li>
                        <li>The JavaScript module will generate automatically</li>
                        <li>Click "Download playlist.js"</li>
                        <li>Replace the existing js/data/playlist.js with your downloaded file</li>
                        <li>Reload the app to use the new playlist</li>
                    </ol>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex items-center justify-end gap-3 px-6 py-4 border-t border-outline-variant">
                <button
                    @click="converterModalOpen = false"
                    class="h-10 px-6 rounded-full text-primary font-medium state-layer hover:bg-primary/8 transition-colors"
                >
                    Cancel
                </button>
                <button
                    @click="downloadPlaylist()"
                    :disabled="!converterOutput || converterChannelCount === 0"
                    class="h-10 px-6 rounded-full bg-primary text-primary-on font-medium state-layer hover:shadow-elevation-1 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:shadow-none flex items-center gap-2"
                >
                    <span class="material-symbols-outlined text-xl">download</span>
                    Download playlist.js
                </button>
            </div>
        </div>
    </div>

    <!-- Main application (ES6 module) - must load before Alpine -->
    <script type="module">
        // Import app module to set up window.appData
        import './js/app.js';

        // Dynamically load Alpine.js after app is ready
        const loadAlpine = () => {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js';
            document.body.appendChild(script);
        };

        // Small delay to ensure appData is available
        if (window.appData) {
            loadAlpine();
        } else {
            // Fallback: wait a tick
            setTimeout(loadAlpine, 0);
        }
    </script>
</body>
</html>
