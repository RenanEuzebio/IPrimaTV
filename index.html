<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Xtream HLS Channel Player</title>

  <!-- hls.js -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <!--
    IMPORTANT
    =========
    This viewer is hosted over HTTPS, while many Xtream panels use plain HTTP.
    Browsers will block “mixed content” XHR requests.  We therefore pipe every
    playlist / segment request through one of several **public CORS proxies**.

    • If one proxy returns 4xx/5xx, the loader automatically tries the next one.
    • For complete reliability, deploy your own Cloudflare‑Worker proxy and
      put its URL at the top of PROXIES below.
  -->

  <style>
    :root{--bg-dark:#111;--bg-light:#1e1e1e;--accent:#007aff;--text:#fff;--muted:#bbb;}
    html,body{height:100%;margin:0;display:flex;background:var(--bg-dark);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;overflow:hidden;}
    #sidebar{width:300px;background:var(--bg-light);display:flex;flex-direction:column;border-right:2px solid #000;}
    #search-container{display:flex;gap:0.5rem;margin:0.5rem;}
    #search{flex:1;padding:0.5rem 0.7rem;border:none;border-radius:4px;background:#272727;color:var(--text);font-size:0.9rem;}
    #prefix-filter{padding:0.5rem 0.7rem;border:none;border-radius:4px;background:#272727;color:var(--text);font-size:0.9rem;cursor:pointer;}
    #channels{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;list-style:none;margin:0;padding:0;}
    .item{padding:0.65rem 0.9rem;border-bottom:1px solid #222;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer;transition:background .2s;}
    .item:hover{background:#2d2d2d;}
    .item.active{background:var(--accent);}  
    #wrap{flex:1;display:flex;flex-direction:column;}
    video{width:100%;height:100%;background:#000;}
    #msg{display:none;padding:0.5rem;font-size:0.9rem;background:#222;color:#f66;max-height:4rem;overflow-y:auto;}
  </style>
</head>
<body>
  <aside id="sidebar">
    <div id="search-container">
      <input id="search" type="text" placeholder="Search channels…" style="width: 100%;" />
      <select id="prefix-filter">
        <option value="">All</option>
      </select>
    </div>
    <ul id="channels"><li style="padding:1rem;color:var(--muted)">Loading…</li></ul>
  </aside>

  <div id="wrap">
    <div id="msg"></div>
    <video id="video" controls autoplay muted></video>
  </div>

<script>
(async()=>{
  const $=q=>document.querySelector(q);
  const list=$('#channels'), search=$('#search'), vid=$('#video'), msg=$('#msg'), prefixFilter=$('#prefix-filter');
  let channels=[], hls=null, current=null;

  /* ─── Helpers ─────────────────────────────────────────────── */
  const show=e=>{msg.textContent=e;msg.style.display='block';console.error(e);};
  const hide=()=>msg.style.display='none';
  const destroy=()=>{if(hls){hls.destroy();hls=null;}};

  /* ─── Proxy rotation ──────────────────────────────────────── */
  const PROXIES=[
    // 1) add your own worker first for best reliability:
    // 'https://your‑worker.<user>.workers.dev/',
    'https://cors.isomorphic-git.org/',
    'https://thingproxy.freeboard.io/fetch/',
    'https://api.allorigins.win/raw?url=',
  ];
  let proxyIndex=0;
  const wrap=(url)=>PROXIES[proxyIndex]+encodeURIComponent(url);
  const nextProxy=()=>{proxyIndex=(proxyIndex+1)%PROXIES.length;};

  const proxify=url=>location.protocol==='https:'&&url.startsWith('http:')?wrap(url):url;

  /* ─── Load channels.json ─────────────────────────────────── */
  try{
    const r=await fetch('./channels.json');
    if(!r.ok) throw new Error(r.status+' '+r.statusText);
    channels=await r.json();
  }catch(e){list.innerHTML='<li style="padding:1rem;color:#f66">Failed to load channels.json</li>';show(e.message);return;}
  if(!channels.length){list.innerHTML='<li style="padding:1rem;color:#f66">channels.json empty</li>';return;}

  /* ─── Extract and populate prefixes ───────────────────────── */
  const extractPrefixes=()=>{
    const prefixes=new Set();
    channels.forEach(c=>{
      // Extract prefix pattern (letters followed by colon at start of name)
      const match=c.name.match(/^([A-Z]+):/i);
      if(match) prefixes.add(match[1].toUpperCase());
    });
    // Sort prefixes alphabetically
    const sorted=Array.from(prefixes).sort();
    // Populate dropdown
    prefixFilter.innerHTML='<option value="">All</option>';
    sorted.forEach(p=>{
      const opt=document.createElement('option');
      opt.value=p;
      opt.textContent=p;
      prefixFilter.appendChild(opt);
    });
  };
  extractPrefixes();

  /* ─── Render + search ─────────────────────────────────────── */
  const render=()=>{
    list.innerHTML='';
    const searchQuery=(search.value||'').trim().toLowerCase();
    const selectedPrefix=prefixFilter.value;
    
    channels.forEach((c,i)=>{
      // Apply prefix filter first
      if(selectedPrefix){
        if(!c.name.toUpperCase().startsWith(selectedPrefix+':'))return;
      }
      
      // Then apply search filter
      if(searchQuery){
        if(!c.name.toLowerCase().includes(searchQuery))return;
      }
      
      const li=document.createElement('li');
      li.className='item';
      li.textContent=c.name;
      li.dataset.i=i;
      li.onclick=()=>select(li);
      list.appendChild(li);
    });
    
    if(!list.firstChild)list.innerHTML='<li style="padding:0.8rem;color:var(--muted)">No matches</li>';
  };
  
  search.oninput=()=>render();
  prefixFilter.onchange=()=>render();

  /* ─── Custom loader with dynamic proxy fallback ───────────── */
  class RotatingProxyLoader extends Hls.DefaultConfig.loader{
    constructor(cfg){super(cfg);}    
    load(ctx,conf,cb){ctx.url=proxify(ctx.url);const orig=ctx.url;const wrapped=this;
      const tryLoad=(attempt=0)=>{
        super.load(ctx,conf,{
          onSuccess:(...a)=>cb.onSuccess(...a),
          onProgress:cb.onProgress,
          onError:(e)=>{
            if(attempt<PROXIES.length-1){nextProxy();ctx.url=wrap(orig.replace(PROXIES[proxyIndex-1],'').replace(/^https:\/\/|^http:\/\//,''));tryLoad(attempt+1);}else cb.onError(e);
          }
        });
      };tryLoad();
    }
  }

  /* ─── Playback ─────────────────────────────────────────────── */
  function play(ch){destroy();hide();proxyIndex=0;
    const base=ch.url.split('?')[0];const first=proxify(base);const fallback=proxify(ch.url);
    const start=url=>{
      if(url.endsWith('.m3u8')&&Hls.isSupported()){
        hls=new Hls({loader:RotatingProxyLoader,xhrSetup:x=>x.withCredentials=false});
        hls.loadSource(url);hls.attachMedia(vid);
        hls.on(Hls.Events.ERROR,(ev,d)=>{
          if(d.fatal&&d.type==='networkError'){
            if(url!==fallback){start(fallback);return;}show('All proxies failed or stream offline');}
        });
      }else if(vid.canPlayType('application/vnd.apple.mpegurl')){vid.src=url;vid.play();}
      else{vid.src=url;vid.play();}
    };start(first);
  }

  function select(li){if(current)current.classList.remove('active');current=li;current.classList.add('active');play(channels[li.dataset.i]);}

  render();const first=list.querySelector('.item');if(first)select(first);
})();
</script>
</body>
</html>
