<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Xtream HLS Channel Player</title>

  <!-- hls.js -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <!-- Mixed‑content safety: we will proxy HTTP → HTTPS if the page is served over HTTPS -->
  <style>
    :root{--bg-dark:#111;--bg-light:#1e1e1e;--accent:#007aff;--text:#fff;--muted:#bbb;}
    html,body{height:100%;margin:0;display:flex;background:var(--bg-dark);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;overflow:hidden;}
    #sidebar{width:300px;background:var(--bg-light);display:flex;flex-direction:column;border-right:2px solid #000;}
    #search{margin:0.5rem;padding:0.5rem 0.7rem;border:none;border-radius:4px;background:#272727;color:var(--text);font-size:0.9rem;}
    #channels{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;list-style:none;margin:0;padding:0;}
    .item{padding:0.65rem 0.9rem;border-bottom:1px solid #222;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer;transition:background .2s;}
    .item:hover{background:#2d2d2d;}
    .item.active{background:var(--accent);}  
    #wrap{flex:1;display:flex;flex-direction:column;}
    video{width:100%;height:100%;background:#000;}
    #msg{display:none;padding:0.5rem;font-size:0.9rem;background:#222;color:#f66;max-height:3.5rem;overflow-y:auto;}
  </style>
</head>
<body>
  <aside id="sidebar">
    <input id="search" type="text" placeholder="Search channels…" />
    <ul id="channels"><li style="padding:1rem;color:var(--muted)">Loading…</li></ul>
  </aside>

  <div id="wrap">
    <div id="msg"></div>
    <video id="video" controls autoplay muted></video>
  </div>

<script>
(async()=>{
  const $=q=>document.querySelector(q);
  const list=$('#channels'), search=$('#search'), vid=$('#video'), msg=$('#msg');
  let channels=[], hls=null, current=null;

  /* ------------- Helpers ----------------*/
  const show=(t)=>{msg.textContent=t;msg.style.display='block';console.error(t);};
  const hide=()=>{msg.style.display='none';};
  const destroy=()=>{if(hls){hls.destroy();hls=null;}};

  // When served over HTTPS, any HTTP media will be blocked => use simple CORS proxy
  const PROXY_PREFIX = 'https://corsproxy.io/?';      // supports Range, no CORS issues
  const proxify = url => location.protocol==='https:' && url.startsWith('http:')
      ? PROXY_PREFIX + encodeURIComponent(url)
      : url;

  /* ------------- Load channels.json -------------*/
  try{
    const r=await fetch('./channels.json');
    if(!r.ok) throw new Error(r.status+' '+r.statusText);
    channels = await r.json();
  }catch(e){
    list.innerHTML='<li style="padding:1rem;color:#f66">Failed to load channels.json</li>';
    show(e.message);
    return;
  }
  if(!Array.isArray(channels)||!channels.length){
    list.innerHTML='<li style="padding:1rem;color:#f66">channels.json empty</li>';
    return;
  }

  /* ------------- Render + search -------------*/
  const render = (filter='') => {
    list.innerHTML='';
    const lo=filter.toLowerCase();
    channels.forEach((c,i)=>{
      if(lo && !c.name.toLowerCase().includes(lo)) return;
      const li=document.createElement('li');
      li.className='item';
      li.textContent=c.name;
      li.dataset.i=i;
      li.onclick=()=>select(li);
      list.appendChild(li);
    });
    if(!list.firstChild) list.innerHTML='<li style="padding:0.8rem;color:var(--muted)">No matches</li>';
  };
  search.oninput=()=>render(search.value);

  /* ------------- Custom Hls loader that applies proxy to every request -------------*/
  class ProxyLoader extends Hls.DefaultConfig.loader {
    constructor(cfg){super(cfg);} // keep default behaviour
    load(context, config, callbacks){
      context.url = proxify(context.url);
      super.load(context, config, callbacks);
    }
  }

  /* ------------- Playback -------------*/
  function play(ch){
    destroy(); hide();

    // prefer fresh redirect (tokenless) url but proxified if needed
    const base = ch.url.split('?')[0];
    const first = proxify(base);
    const fallback = proxify(ch.url);

    const start = url => {
      if(url.endsWith('.m3u8') && Hls.isSupported()){
        hls=new Hls({loader:ProxyLoader,xhrSetup:x=>x.withCredentials=false});
        hls.loadSource(url);
        hls.attachMedia(vid);
        hls.on(Hls.Events.ERROR,(ev,d)=>{
          if(d.fatal && d.type==='networkError'){
            if(url!==fallback){start(fallback);return;} // second try with token
            show('Network / CORS error: stream blocked');
          }
        });
      }else if(vid.canPlayType('application/vnd.apple.mpegurl')){
        vid.src=url;
      }else{vid.src=url;}
      vid.play().catch(()=>{});
    };

    start(first);
  }

  function select(li){
    if(current) current.classList.remove('active');
    current=li; current.classList.add('active');
    play(channels[li.dataset.i]);
  }

  render();
  const first=list.querySelector('.item'); if(first) select(first);
})();
</script>
</body>
</html>
